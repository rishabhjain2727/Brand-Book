<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brand Book Creator — Completion Card</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    :root {
      --primary: #f37c21;
      --secondary: #c65010;
      --accent: #4361ee;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #10b981;
      --warning: #f72585;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
      background-color: #f5f7fb;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: white;
      box-shadow: var(--shadow);
      padding: 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }

    .logo i {
      font-size: 24px;
      color: var(--primary);
      margin-right: 10px;
    }

    .logo h1 {
      font-size: 20px;
      font-weight: 700;
    }

    .small-note {
      font-size: 12px;
      color: var(--gray);
      margin-bottom: 15px;
    }

    .pillar-list {
      list-style: none;
    }

    .pillar-item {
      margin-bottom: 5px;
    }

    .pillar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background-color: var(--light);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 14px;
    }

    .pillar-header:hover {
      background-color: var(--light-gray);
    }

    .pillar-header.active {
      background-color: var(--primary);
      color: white;
    }

    .pillar-header i {
      font-size: 14px;
      transition: var(--transition);
    }

    .pillar-header.active i {
      transform: rotate(90deg);
    }

    .sub-pillars {
      list-style: none;
      max-height: 0;
      overflow: hidden;
      transition: var(--transition);
      padding-left: 10px;
    }

    .sub-pillars.show {
      max-height: 600px;
    }

    .sub-pillar {
      padding: 8px 14px;
      border-left: 2px solid var(--light-gray);
      margin: 4px 0;
      cursor: pointer;
      transition: var(--transition);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-radius: 6px;
    }

    .sub-pillar:hover {
      border-left-color: var(--accent);
      background-color: rgba(72, 149, 239, 0.06);
    }

    .sub-pillar.active {
      border-left-color: var(--primary);
      background-color: rgba(67, 97, 238, 0.08);
      font-weight: 600;
    }

    .sub-pillar-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sub-pillar i {
      font-size: 11px;
      color: var(--gray);
    }

    .sub-pillar.active i {
      color: var(--primary);
    }

    .sub-pillar .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--light-gray);
    }

    .sub-pillar.completed .status-dot {
      background: var(--success);
    }

    /* Main content */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--light-gray);
    }

    .content-header h2 {
      font-size: 22px;
      color: var(--dark);
    }

    .content-sub {
      font-size: 13px;
      color: var(--gray);
    }

    /* ===== LPU-style completion card ===== */
    .progress-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #f37021, #f9a826);
      border-radius: 10px;
      color: white;
      box-shadow: var(--shadow);
      min-width: 280px;
    }

    .progress-title {
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.95;
      letter-spacing: 0.06em;
    }

    .progress-main-num {
      font-size: 30px;
      font-weight: 700;
      line-height: 1.05;
    }

    .progress-bar {
      width: 280px;
      height: 14px;
      background-color: rgba(255, 255, 255, 0.25);
      border-radius: 14px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: linear-gradient(90deg, #ffffff, #d2f5dd);
      width: 0%;
      border-radius: 14px;
      transition: width 0.45s cubic-bezier(.2,.9,.2,1);
    }

    .progress-text {
      font-size: 12px;
      font-weight: 600;
    }

    /* Form styles */
    .form-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease;
    }

    .form-header h3 {
      font-size: 18px;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .form-header p {
      font-size: 13px;
      color: var(--gray);
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--dark);
      font-size: 14px;
    }

    .form-group .hint {
      font-size: 12px;
      color: var(--gray);
      margin-top: 4px;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      font-size: 14px;
      transition: var(--transition);
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(72, 149, 239, 0.2);
    }

    .swot-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .swot-box {
      border-radius: var(--border-radius);
      border: 1px solid var(--light-gray);
      padding: 10px;
      background: var(--light);
    }

    .swot-box h4 {
      font-size: 13px;
      margin-bottom: 6px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    .btn {
      padding: 10px 18px;
      border-radius: var(--border-radius);
      border: none;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary);
    }

    .btn-outline {
      border: 1px solid var(--primary);
      color: var(--primary);
      background: transparent;
    }

    .btn-outline:hover {
      background: rgba(67, 97, 238, 0.08);
    }

    .empty-state {
      text-align: center;
      color: var(--gray);
      padding: 60px 20px;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 12px;
      color: var(--light-gray);
    }

    /* Market Position Map Styles */
    .position-map-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
    }

    .map-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .map-controls {
        grid-template-columns: 1fr;
      }
    }

    .axis-control {
      background: var(--light);
      padding: 15px;
      border-radius: var(--border-radius);
      border: 1px solid var(--light-gray);
    }

    .axis-control h4 {
      margin-bottom: 10px;
      color: var(--dark);
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .axis-control h4 i {
      color: var(--primary);
    }

    .axis-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .axis-option {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 6px 0;
    }

    .axis-option input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .competitor-map {
      position: relative;
      width: 100%;
      height: 500px;
      background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), 
                  linear-gradient(-45deg, #f8f9fa 25%, transparent 25%), 
                  linear-gradient(45deg, transparent 75%, #f8f9fa 75%), 
                  linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      border: 2px solid var(--dark);
      border-radius: var(--border-radius);
      overflow: hidden;
      margin: 20px 0;
    }

    .axis-line {
      position: absolute;
      background-color: var(--gray);
    }

    .axis-x {
      width: 100%;
      height: 2px;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
    }

    .axis-y {
      width: 2px;
      height: 100%;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
    }

    .quadrant-label {
      position: absolute;
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      padding: 4px 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.9);
      text-align: center;
      min-width: 80px;
    }

    .quadrant-1 {
      top: 20px;
      right: 20px;
      color: #10b981;
      border: 1px solid #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .quadrant-2 {
      top: 20px;
      left: 20px;
      color: #4361ee;
      border: 1px solid #4361ee;
      background: rgba(67, 97, 238, 0.1);
    }

    .quadrant-3 {
      bottom: 20px;
      left: 20px;
      color: #f72585;
      border: 1px solid #f72585;
      background: rgba(247, 37, 133, 0.1);
    }

    .quadrant-4 {
      bottom: 20px;
      right: 20px;
      color: #f37c21;
      border: 1px solid #f37c21;
      background: rgba(243, 124, 33, 0.1);
    }

    .axis-label {
      position: absolute;
      font-size: 13px;
      font-weight: 600;
      color: var(--dark);
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--light-gray);
    }

    .x-label-left {
      bottom: 10px;
      left: 10px;
    }

    .x-label-right {
      bottom: 10px;
      right: 10px;
    }

    .y-label-top {
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .y-label-bottom {
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .competitor-dot {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      z-index: 10;
      border: 2px solid white;
      user-select: none;
    }

    .competitor-dot:hover {
      transform: scale(1.3);
      box-shadow: 0 5px 12px rgba(0,0,0,0.3);
      z-index: 20;
    }

    .competitor-dot.selected {
      box-shadow: 0 0 0 3px var(--accent), 0 5px 15px rgba(0,0,0,0.3);
      transform: scale(1.2);
    }

    .competitor-dot::after {
      content: attr(data-initial);
      font-weight: bold;
    }

    .competitor-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .competitor-list {
        grid-template-columns: 1fr;
      }
    }

    .competitor-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--light);
      border-radius: var(--border-radius);
      border: 1px solid var(--light-gray);
      transition: var(--transition);
    }

    .competitor-item:hover {
      background: white;
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .competitor-item.selected {
      background: white;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }

    .competitor-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .competitor-info {
      flex: 1;
      min-width: 0;
    }

    .competitor-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .competitor-position {
      font-size: 11px;
      color: var(--gray);
      display: flex;
      gap: 8px;
    }

    .competitor-actions {
      display: flex;
      gap: 6px;
    }

    .competitor-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray);
      font-size: 13px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .competitor-actions button:hover {
      color: var(--dark);
      background: rgba(0,0,0,0.05);
    }

    .add-competitor-form {
      background: var(--light);
      padding: 20px;
      border-radius: var(--border-radius);
      border: 2px dashed var(--light-gray);
      margin-top: 25px;
    }

    .add-competitor-form h4 {
      margin-bottom: 15px;
      color: var(--dark);
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .add-competitor-form h4 i {
      color: var(--primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .color-picker {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .color-picker input {
      width: 40px;
      height: 40px;
      padding: 0;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      flex-shrink: 0;
    }

    .color-picker label {
      margin-bottom: 0;
      font-size: 13px;
      font-weight: 600;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid var(--light-gray);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      padding: 6px 12px;
      background: rgba(0,0,0,0.02);
      border-radius: 6px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .map-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }

    .instruction {
      font-size: 12px;
      color: var(--gray);
      font-style: italic;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .instruction i {
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="logo">
        <i class="fas fa-book"></i>
        <h1>Brand Book Creator</h1>
      </div>
      <p class="small-note">
        Click a pillar → choose a sub-pillar → fill the section. Saved sections
        update the completion graph.
      </p>
      <ul class="pillar-list" id="pillarList"></ul>
    </div>

    <!-- MAIN -->
    <div class="main-content">
      <div class="content-header">
        <div>
          <h2 id="sectionTitle">Select a section</h2>
          <p id="sectionSubtitle" class="content-sub">
            Start by choosing a pillar and sub-pillar from the left.
          </p>
        </div>

        <!-- LPU-style completion card -->
        <div class="progress-container" aria-hidden="false" id="completionCard">
          <div class="progress-title">Brand Book Completion</div>
          <div class="progress-main-num" id="progressPercent">0%</div>
          <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
          </div>
          <span class="progress-text" id="progressText">0% Complete (0 / 0)</span>
        </div>
      </div>

      <div id="formRoot">
        <div class="form-container">
          <div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h3>No section selected</h3>
            <p>
              Pick any sub-pillar from the sidebar to start editing your brand
              book.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------- CONFIG: ALL PILLARS & SUB-PILLARS --------
    const BRAND_STRUCTURE = [
      {
        id: "brand-overview",
        label: "Brand Overview",
        sections: [
          {
            id: "brand-history",
            label: "Brand History",
            type: "long",
            hint: "Timeline or story of how the brand evolved over time."
          },
          {
            id: "brand-purpose",
            label: "Brand Purpose",
            type: "short",
            hint: "One clear line on why the brand exists beyond profit."
          },
          {
            id: "company-snapshot",
            label: "Company Snapshot",
            type: "table",
            hint: "Current overview: size, locations, key facts."
          }
        ]
      },
      {
        id: "mission-vision",
        label: "Mission & Vision",
        sections: [
          {
            id: "vision-statement",
            label: "Vision Statement",
            type: "long",
            hint: "Future state you want to create."
          },
          {
            id: "purpose-summary",
            label: "Purpose Summary",
            type: "short"
          },
          {
            id: "strategic-objectives",
            label: "Strategic Objectives",
            type: "table",
            hint: "List 3–5 key objectives."
          },
          {
            id: "long-term-aspirations",
            label: "Long-term Aspirations",
            type: "long"
          }
        ]
      },
      {
        id: "brand-positioning",
        label: "Brand Positioning",
        sections: [
          { id: "brand-promise", label: "Brand Promise", type: "short" },
          {
            id: "value-proposition",
            label: "Value Proposition",
            type: "long"
          },
          { id: "usp", label: "USP", type: "long" },
          {
            id: "perception-mapping",
            label: "Perception Mapping",
            type: "long",
            hint: "Describe axes & where you/competitors sit."
          }
        ]
      },
      {
        id: "competitive-landscape",
        label: "Competitive Landscape",
        sections: [
          {
            id: "market-position-map",
            label: "Market Position Map",
            type: "position-map", // NEW TYPE
            hint: "Visualize competitors on a strategic grid. Drag and position companies based on market attributes."
          },
          {
            id: "swot-analysis",
            label: "SWOT Analysis",
            type: "swot"
          },
          {
            id: "differentiation-factors",
            label: "Differentiation Factors",
            type: "long"
          },
          {
            id: "industry-benchmarks",
            label: "Industry Benchmarks",
            type: "table"
          }
        ]
      },
      {
        id: "brand-personality",
        label: "Brand Personality",
        sections: [
          {
            id: "brand-archetype",
            label: "Brand Archetype",
            type: "short"
          },
          {
            id: "voice-attributes",
            label: "Voice Attributes",
            type: "long"
          },
          {
            id: "emotional-associations",
            label: "Emotional Associations",
            type: "long"
          }
        ]
      }
      // ... (other pillars remain)
    ];

    // ---------- STATE ----------
    const completionState = {};
    const totalSections = BRAND_STRUCTURE.reduce(
      (sum, p) => sum + p.sections.length,
      0
    );

    // ---------- DOM REFS ----------
    const pillarListEl = document.getElementById("pillarList");
    const formRoot = document.getElementById("formRoot");
    const sectionTitleEl = document.getElementById("sectionTitle");
    const sectionSubtitleEl = document.getElementById("sectionSubtitle");
    const progressBarEl = document.getElementById("progressBar");
    const progressTextEl = document.getElementById("progressText");
    const progressPercentEl = document.getElementById("progressPercent");

    // ---------- RENDER SIDEBAR ----------
    function renderSidebar() {
      pillarListEl.innerHTML = "";
      BRAND_STRUCTURE.forEach((pillar, idx) => {
        const li = document.createElement("li");
        li.className = "pillar-item";

        const header = document.createElement("div");
        header.className = "pillar-header" + (idx === 0 ? " active" : "");
        header.dataset.pillarId = pillar.id;
        header.innerHTML = `
          <span>${pillar.label}</span>
          <i class="fas fa-chevron-right"></i>
        `;

        const subList = document.createElement("ul");
        subList.className = "sub-pillars" + (idx === 0 ? " show" : "");
        pillar.sections.forEach((sec, sIdx) => {
          const subLi = document.createElement("li");
          subLi.className =
            "sub-pillar" +
            (idx === 0 && sIdx === 0 ? " active" : "");
          subLi.dataset.sectionId = sec.id;
          subLi.innerHTML = `
            <div class="sub-pillar-left">
              <i class="fas fa-circle-notch"></i>
              <span>${sec.label}</span>
            </div>
            <span class="status-dot"></span>
          `;
          subList.appendChild(subLi);
        });

        li.appendChild(header);
        li.appendChild(subList);
        pillarListEl.appendChild(li);
      });

      bindSidebarEvents();
    }

    function bindSidebarEvents() {
      document.querySelectorAll(".pillar-header").forEach((header) => {
        header.addEventListener("click", () => {
          document.querySelectorAll(".pillar-header").forEach((h) => {
            if (h !== header) {
              h.classList.remove("active");
              h.nextElementSibling.classList.remove("show");
            }
          });
          header.classList.toggle("active");
          header.nextElementSibling.classList.toggle("show");
        });
      });

      document.querySelectorAll(".sub-pillar").forEach((sub) => {
        sub.addEventListener("click", () => {
          const sectionId = sub.dataset.sectionId;
          document
            .querySelectorAll(".sub-pillar")
            .forEach((s) => s.classList.remove("active"));
          sub.classList.add("active");
          const section = findSectionById(sectionId);
          renderSectionForm(section);
        });
      });
    }

    function findSectionById(id) {
      for (const pillar of BRAND_STRUCTURE) {
        for (const sec of pillar.sections) {
          if (sec.id === id) return { pillar, sec };
        }
      }
      return null;
    }

    // ---------- RENDER SECTION FORM ----------
    function renderSectionForm({ pillar, sec }) {
      sectionTitleEl.textContent = sec.label;
      sectionSubtitleEl.textContent = pillar.label;

      const container = document.createElement("div");
      container.className = "form-container";

      const header = document.createElement("div");
      header.className = "form-header";
      header.innerHTML = `
        <h3>${sec.label}</h3>
        <p>${sec.hint || "Fill the content for this brand book section."}</p>
      `;
      container.appendChild(header);

      const formBody = document.createElement("div");

      switch (sec.type) {
        case "short":
          formBody.appendChild(makeShortField(sec));
          break;
        case "upload":
          formBody.appendChild(makeUploadField());
          break;
        case "table":
          formBody.appendChild(makeTableField());
          break;
        case "swot":
          formBody.appendChild(makeSwotField());
          break;
        case "color":
          formBody.appendChild(makeColorField());
          break;
        case "position-map": // NEW CASE
          formBody.appendChild(makePositionMapField());
          break;
        case "long":
        default:
          formBody.appendChild(makeLongField(sec));
          break;
      }

      container.appendChild(formBody);

      const actions = document.createElement("div");
      actions.className = "form-actions";
      actions.innerHTML = `
        <button class="btn btn-outline" type="button" id="resetBtn">
          <i class="fas fa-rotate-left"></i> Reset
        </button>
        <button class="btn btn-primary" type="button" id="saveBtn">
          Save Section <i class="fas fa-check"></i>
        </button>
      `;

      container.appendChild(actions);
      formRoot.innerHTML = "";
      formRoot.appendChild(container);

      // Attach reset and save handlers
      document.getElementById('resetBtn').addEventListener('click', () => {
        if (sec.type === "position-map") {
          if (confirm("Reset all competitors and map settings?")) {
            resetPositionMap();
          }
        } else {
          container.querySelectorAll("input, textarea").forEach((el) => {
            if (el.type === "color") return;
            if (el.type === "radio") return;
            el.value = "";
          });
          container
            .querySelectorAll(".chip-toggle")
            .forEach((c) => c.classList.remove("active"));
        }
      });

      document.getElementById('saveBtn').addEventListener('click', () => {
        completionState[sec.id] = true;
        updateCompletionUI();
        markSidebarCompleted(sec.id);
        // Show save confirmation
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
        saveBtn.style.backgroundColor = '#10b981';
        setTimeout(() => {
          saveBtn.innerHTML = originalText;
          saveBtn.style.backgroundColor = '';
        }, 1500);
      });

      // If this is position-map, initialize it
      if (sec.type === "position-map") {
        initializePositionMap();
      }
    }

    // ---------- FIELD BUILDERS ----------
    function makeShortField(sec) {
      const wrapper = document.createElement("div");
      wrapper.className = "form-group";
      wrapper.innerHTML = `
        <label>${sec.label}</label>
        <input type="text" placeholder="Write a concise line here..." />
      `;
      return wrapper;
    }

    function makeLongField(sec) {
      const wrapper = document.createElement("div");
      wrapper.className = "form-group";
      wrapper.innerHTML = `
        <label>${sec.label}</label>
        <textarea placeholder="Write detailed content for this section..."></textarea>
        <div class="hint">Use paragraphs or bullet points as needed.</div>
      `;
      return wrapper;
    }

    function makeUploadField() {
      const wrapper = document.createElement("div");
      wrapper.className = "form-group";
      wrapper.innerHTML = `
        <label>Upload Asset</label>
        <div class="file-upload">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Click to simulate uploading an image/file</p>
        </div>
        <div class="hint">In a real app this would open the file picker.</div>
      `;
      wrapper.querySelector(".file-upload").addEventListener("click", (e) => {
        e.currentTarget.innerHTML =
          '<i class="fas fa-check-circle"></i><p>File uploaded (demo)</p>';
        e.currentTarget.style.borderColor = "var(--accent)";
        e.currentTarget.style.backgroundColor = "rgba(72,149,239,0.08)";
      });
      return wrapper;
    }

    function makeTableField() {
      const wrapper = document.createElement("div");
      wrapper.className = "form-group";
      wrapper.innerHTML = `
        <label>Structured List</label>
        <div class="swot-grid">
          <div class="swot-box">
            <h4>Item 1</h4>
            <textarea placeholder="Describe item 1"></textarea>
          </div>
          <div class="swot-box">
            <h4>Item 2</h4>
            <textarea placeholder="Describe item 2"></textarea>
          </div>
          <div class="swot-box">
            <h4>Item 3</h4>
            <textarea placeholder="Describe item 3"></textarea>
          </div>
          <div class="swot-box">
            <h4>Item 4</h4>
            <textarea placeholder="Describe item 4"></textarea>
          </div>
        </div>
      `;
      return wrapper;
    }

    function makeSwotField() {
      const wrapper = document.createElement("div");
      wrapper.className = "form-group";
      wrapper.innerHTML = `
        <label>SWOT Analysis</label>
        <div class="swot-grid">
          <div class="swot-box">
            <h4>Strengths</h4>
            <textarea placeholder="Internal positive attributes"></textarea>
          </div>
          <div class="swot-box">
            <h4>Weaknesses</h4>
            <textarea placeholder="Internal negative attributes"></textarea>
          </div>
          <div class="swot-box">
            <h4>Opportunities</h4>
            <textarea placeholder="External positive factors"></textarea>
          </div>
          <div class="swot-box">
            <h4>Threats</h4>
            <textarea placeholder="External negative factors"></textarea>
          </div>
        </div>
      `;
      return wrapper;
    }

    function makeColorField() {
      const wrapper = document.createElement("div");
      wrapper.className = "form-group";
      wrapper.innerHTML = `
        <label>Primary Color</label>
        <input type="color" value="#4361ee" />
        <div class="hint">Pick your brand secondary or accent color.</div>
      `;
      return wrapper;
    }

    // NEW: Position Map Field Builder
    function makePositionMapField() {
      const wrapper = document.createElement("div");
      wrapper.className = "position-map-container";
      wrapper.innerHTML = `
        <div class="map-controls">
          <div class="axis-control">
            <h4><i class="fas fa-arrows-alt-h"></i> X-Axis Dimension</h4>
            <div class="axis-options">
              <label class="axis-option">
                <input type="radio" name="x-axis" value="price" checked>
                Price (Low to High)
              </label>
              <label class="axis-option">
                <input type="radio" name="x-axis" value="quality">
                Quality (Low to High)
              </label>
              <label class="axis-option">
                <input type="radio" name="x-axis" value="innovation">
                Innovation (Traditional to Innovative)
              </label>
              <label class="axis-option">
                <input type="radio" name="x-axis" value="market-share">
                Market Share (Small to Large)
              </label>
            </div>
          </div>
          
          <div class="axis-control">
            <h4><i class="fas fa-arrows-alt-v"></i> Y-Axis Dimension</h4>
            <div class="axis-options">
              <label class="axis-option">
                <input type="radio" name="y-axis" value="growth" checked>
                Growth Rate (Low to High)
              </label>
              <label class="axis-option">
                <input type="radio" name="y-axis" value="premium">
                Premium Positioning (Economy to Luxury)
              </label>
              <label class="axis-option">
                <input type="radio" name="y-axis" value="customer-satisfaction">
                Customer Satisfaction (Low to High)
              </label>
              <label class="axis-option">
                <input type="radio" name="y-axis" value="digital-presence">
                Digital Presence (Weak to Strong)
              </label>
            </div>
          </div>
        </div>

        <div class="competitor-map" id="competitorMap">
          <!-- Map will be dynamically generated -->
        </div>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background-color: #4361ee;"></div>
            <span>Your Brand</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #f72585;"></div>
            <span>Direct Competitors</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #10b981;"></div>
            <span>Indirect Competitors</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #f37c21;"></div>
            <span>Market Leaders</span>
          </div>
        </div>

        <div class="add-competitor-form">
          <h4><i class="fas fa-plus-circle"></i> Add Competitor</h4>
          <div class="form-row">
            <div>
              <label>Competitor Name</label>
              <input type="text" id="competitorName" placeholder="Enter competitor name">
            </div>
            <div class="color-picker">
              <label>Color</label>
              <input type="color" id="competitorColor" value="#f72585">
            </div>
            <div>
              <label>Type</label>
              <select id="competitorType">
                <option value="direct">Direct Competitor</option>
                <option value="indirect">Indirect Competitor</option>
                <option value="leader">Market Leader</option>
                <option value="new">New Entrant</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" id="addCompetitorBtn">
            <i class="fas fa-plus"></i> Add to Map
          </button>
          <p class="instruction">
            <i class="fas fa-info-circle"></i> Tip: After adding, drag competitors on the map to position them
          </p>
        </div>

        <div class="competitor-list" id="competitorList">
          <!-- Competitor list will be dynamically generated -->
        </div>
      `;
      return wrapper;
    }

    // ---------- POSITION MAP LOGIC ----------
    let competitors = [];
    let selectedCompetitor = null;
    let isDragging = false;

    function initializePositionMap() {
      // Initialize with sample data
      competitors = [
        { id: 1, name: "Your Brand", color: "#4361ee", type: "your-brand", x: 50, y: 50 },
        { id: 2, name: "Apple", color: "#f72585", type: "leader", x: 80, y: 75 },
        { id: 3, name: "Samsung", color: "#f72585", type: "direct", x: 70, y: 60 },
        { id: 4, name: "Google", color: "#10b981", type: "indirect", x: 60, y: 40 },
        { id: 5, name: "Microsoft", color: "#f37c21", type: "leader", x: 65, y: 70 }
      ];

      renderMap();
      renderCompetitorList();
      setupEventListeners();
    }

    function renderMap() {
      const map = document.getElementById('competitorMap');
      map.innerHTML = '';

      // Add grid background
      const gridSize = 50;
      for (let i = 0; i < map.clientWidth / gridSize; i++) {
        const verticalLine = document.createElement('div');
        verticalLine.style.position = 'absolute';
        verticalLine.style.left = `${i * gridSize}px`;
        verticalLine.style.top = '0';
        verticalLine.style.width = '1px';
        verticalLine.style.height = '100%';
        verticalLine.style.backgroundColor = 'rgba(0,0,0,0.05)';
        map.appendChild(verticalLine);
      }

      for (let i = 0; i < map.clientHeight / gridSize; i++) {
        const horizontalLine = document.createElement('div');
        horizontalLine.style.position = 'absolute';
        horizontalLine.style.top = `${i * gridSize}px`;
        horizontalLine.style.left = '0';
        horizontalLine.style.width = '100%';
        horizontalLine.style.height = '1px';
        horizontalLine.style.backgroundColor = 'rgba(0,0,0,0.05)';
        map.appendChild(horizontalLine);
      }

      // Add axis lines
      const axisX = document.createElement('div');
      axisX.className = 'axis-line axis-x';
      map.appendChild(axisX);

      const axisY = document.createElement('div');
      axisY.className = 'axis-line axis-y';
      map.appendChild(axisY);

      // Add quadrant labels
      const quadrant1 = document.createElement('div');
      quadrant1.className = 'quadrant-label quadrant-1';
      quadrant1.textContent = 'High Growth / High Price';
      map.appendChild(quadrant1);

      const quadrant2 = document.createElement('div');
      quadrant2.className = 'quadrant-label quadrant-2';
      quadrant2.textContent = 'High Growth / Low Price';
      map.appendChild(quadrant2);

      const quadrant3 = document.createElement('div');
      quadrant3.className = 'quadrant-label quadrant-3';
      quadrant3.textContent = 'Low Growth / Low Price';
      map.appendChild(quadrant3);

      const quadrant4 = document.createElement('div');
      quadrant4.className = 'quadrant-label quadrant-4';
      quadrant4.textContent = 'Low Growth / High Price';
      map.appendChild(quadrant4);

      // Add axis labels
      const xLabelLeft = document.createElement('div');
      xLabelLeft.className = 'axis-label x-label-left';
      xLabelLeft.textContent = 'Low Price';
      map.appendChild(xLabelLeft);

      const xLabelRight = document.createElement('div');
      xLabelRight.className = 'axis-label x-label-right';
      xLabelRight.textContent = 'High Price';
      map.appendChild(xLabelRight);

      const yLabelTop = document.createElement('div');
      yLabelTop.className = 'axis-label y-label-top';
      yLabelTop.textContent = 'High Growth';
      map.appendChild(yLabelTop);

      const yLabelBottom = document.createElement('div');
      yLabelBottom.className = 'axis-label y-label-bottom';
      yLabelBottom.textContent = 'Low Growth';
      map.appendChild(yLabelBottom);

      // Add competitor dots
      competitors.forEach(competitor => {
        const dot = document.createElement('div');
        dot.className = 'competitor-dot' + (selectedCompetitor?.id === competitor.id ? ' selected' : '');
        dot.style.backgroundColor = competitor.color;
        dot.style.left = `calc(${competitor.x}% - 16px)`;
        dot.style.top = `calc(${100 - competitor.y}% - 16px)`;
        dot.dataset.id = competitor.id;
        dot.dataset.initial = competitor.name.charAt(0).toUpperCase();
        dot.title = competitor.name;
        
        // Add glow effect for your brand
        if (competitor.type === 'your-brand') {
          dot.style.boxShadow = '0 0 10px ' + competitor.color;
          dot.classList.add('pulse');
        }

        map.appendChild(dot);
      });
    }

    function renderCompetitorList() {
      const list = document.getElementById('competitorList');
      list.innerHTML = '';

      competitors.forEach(competitor => {
        const item = document.createElement('div');
        item.className = 'competitor-item' + (selectedCompetitor?.id === competitor.id ? ' selected' : '');
        item.dataset.id = competitor.id;
        
        // Get competitor type label
        let typeLabel = '';
        switch(competitor.type) {
          case 'your-brand': typeLabel = 'Your Brand'; break;
          case 'direct': typeLabel = 'Direct Competitor'; break;
          case 'indirect': typeLabel = 'Indirect Competitor'; break;
          case 'leader': typeLabel = 'Market Leader'; break;
          case 'new': typeLabel = 'New Entrant'; break;
        }

        item.innerHTML = `
          <div class="competitor-color" style="background-color: ${competitor.color};"></div>
          <div class="competitor-info">
            <div class="competitor-name">${competitor.name}</div>
            <div class="competitor-position">
              <span>${typeLabel}</span>
              <span>Position: ${competitor.x}%, ${competitor.y}%</span>
            </div>
          </div>
          <div class="competitor-actions">
            <button class="select-btn" title="Select on map">
              <i class="fas fa-crosshairs"></i>
            </button>
            <button class="delete-btn" title="Remove competitor">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;

        list.appendChild(item);
      });
    }

    function setupEventListeners() {
      // Add competitor button
      document.getElementById('addCompetitorBtn').addEventListener('click', addCompetitor);

      // Map click for selection
      const map = document.getElementById('competitorMap');
      map.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);

      // Competitor list events (delegated)
      document.getElementById('competitorList').addEventListener('click', function(e) {
        const competitorItem = e.target.closest('.competitor-item');
        if (!competitorItem) return;

        const id = parseInt(competitorItem.dataset.id);
        
        if (e.target.closest('.select-btn')) {
          selectCompetitor(id);
        } else if (e.target.closest('.delete-btn')) {
          deleteCompetitor(id);
        } else {
          selectCompetitor(id);
        }
      });

      // Axis control changes
      document.querySelectorAll('input[name="x-axis"], input[name="y-axis"]').forEach(input => {
        input.addEventListener('change', updateAxisLabels);
      });
    }

    function addCompetitor() {
      const nameInput = document.getElementById('competitorName');
      const colorInput = document.getElementById('competitorColor');
      const typeInput = document.getElementById('competitorType');

      const name = nameInput.value.trim();
      if (!name) {
        alert('Please enter a competitor name');
        return;
      }

      const newCompetitor = {
        id: competitors.length + 1,
        name: name,
        color: colorInput.value,
        type: typeInput.value,
        x: Math.floor(Math.random() * 40) + 30, // Random position
        y: Math.floor(Math.random() * 40) + 30
      };

      competitors.push(newCompetitor);
      renderMap();
      renderCompetitorList();
      
      // Reset form
      nameInput.value = '';
      colorInput.value = '#f72585';
      typeInput.value = 'direct';
      
      // Select the new competitor
      selectCompetitor(newCompetitor.id);
    }

    function selectCompetitor(id) {
      selectedCompetitor = competitors.find(c => c.id === id);
      renderMap();
      renderCompetitorList();
    }

    function deleteCompetitor(id) {
      if (id === 1) { // Prevent deleting "Your Brand"
        alert('Cannot delete "Your Brand"');
        return;
      }
      
      if (confirm('Are you sure you want to remove this competitor?')) {
        competitors = competitors.filter(c => c.id !== id);
        if (selectedCompetitor?.id === id) {
          selectedCompetitor = null;
        }
        renderMap();
        renderCompetitorList();
      }
    }

    function startDrag(e) {
      const dot = e.target.closest('.competitor-dot');
      if (!dot) return;
      
      e.preventDefault();
      isDragging = true;
      const id = parseInt(dot.dataset.id);
      selectCompetitor(id);
    }

    function drag(e) {
      if (!isDragging || !selectedCompetitor) return;

      const map = document.getElementById('competitorMap');
      const rect = map.getBoundingClientRect();
      
      // Calculate percentage position
      let x = ((e.clientX - rect.left) / rect.width) * 100;
      let y = ((rect.bottom - e.clientY) / rect.height) * 100;
      
      // Constrain to map bounds
      x = Math.max(0, Math.min(100, x));
      y = Math.max(0, Math.min(100, y));
      
      // Update competitor position
      selectedCompetitor.x = x;
      selectedCompetitor.y = y;
      
      // Update visual
      const dot = document.querySelector(`.competitor-dot[data-id="${selectedCompetitor.id}"]`);
      if (dot) {
        dot.style.left = `calc(${x}% - 16px)`;
        dot.style.top = `calc(${100 - y}% - 16px)`;
      }
      
      // Update list
      renderCompetitorList();
    }

    function stopDrag() {
      isDragging = false;
    }

    function updateAxisLabels() {
      const xAxis = document.querySelector('input[name="x-axis"]:checked').value;
      const yAxis = document.querySelector('input[name="y-axis"]:checked').value;
      
      // Get labels based on selected axes
      const xLabels = {
        price: { left: 'Low Price', right: 'High Price' },
        quality: { left: 'Low Quality', right: 'High Quality' },
        innovation: { left: 'Traditional', right: 'Innovative' },
        'market-share': { left: 'Small', right: 'Large' }
      };
      
      const yLabels = {
        growth: { top: 'High Growth', bottom: 'Low Growth' },
        premium: { top: 'Luxury', bottom: 'Economy' },
        'customer-satisfaction': { top: 'High Satisfaction', bottom: 'Low Satisfaction' },
        'digital-presence': { top: 'Strong', bottom: 'Weak' }
      };
      
      // Update labels
      document.querySelector('.x-label-left').textContent = xLabels[xAxis].left;
      document.querySelector('.x-label-right').textContent = xLabels[xAxis].right;
      document.querySelector('.y-label-top').textContent = yLabels[yAxis].top;
      document.querySelector('.y-label-bottom').textContent = yLabels[yAxis].bottom;
      
      // Update quadrant labels
      document.querySelector('.quadrant-1').textContent = `${yLabels[yAxis].top} / ${xLabels[xAxis].right}`;
      document.querySelector('.quadrant-2').textContent = `${yLabels[yAxis].top} / ${xLabels[xAxis].left}`;
      document.querySelector('.quadrant-3').textContent = `${yLabels[yAxis].bottom} / ${xLabels[xAxis].left}`;
      document.querySelector('.quadrant-4').textContent = `${yLabels[yAxis].bottom} / ${xLabels[xAxis].right}`;
    }

    function resetPositionMap() {
      if (confirm('This will reset all competitors and map settings. Continue?')) {
        competitors = [
          { id: 1, name: "Your Brand", color: "#4361ee", type: "your-brand", x: 50, y: 50 }
        ];
        selectedCompetitor = null;
        
        // Reset axis controls
        document.querySelector('input[name="x-axis"][value="price"]').checked = true;
        document.querySelector('input[name="y-axis"][value="growth"]').checked = true;
        
        renderMap();
        renderCompetitorList();
        updateAxisLabels();
      }
    }

    // ---------- COMPLETION ----------
    function updateCompletionUI() {
      const completed = Object.keys(completionState).length;
      const percent = totalSections ? Math.round((completed / totalSections) * 100) : 0;
      progressBarEl.style.width = percent + "%";
      progressPercentEl.textContent = `${percent}%`;
      progressTextEl.textContent = `${percent}% Complete (${completed} / ${totalSections})`;
    }

    function markSidebarCompleted(sectionId) {
      const node = document.querySelector(
        `.sub-pillar[data-section-id="${sectionId}"]`
      );
      if (node) node.classList.add("completed");
    }

    // ---------- INIT ----------
    renderSidebar();
    updateCompletionUI();

    // Open first section by default
    const firstPillar = BRAND_STRUCTURE[0];
    if (firstPillar && firstPillar.sections[0]) {
      const firstSec = firstPillar.sections[0];
      const node = document.querySelector(
        `.sub-pillar[data-section-id="${firstSec.id}"]`
      );
      if (node) node.classList.add("active");
      renderSectionForm({ pillar: firstPillar, sec: firstSec });
    }
  </script>
</body>
</html>
